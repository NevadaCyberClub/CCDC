# Ensure the script is run with administrative privileges.
if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole(
    [Security.Principal.WindowsBuiltinRole]::Administrator)) {
    Write-Error "This script must be run as an Administrator."
    exit 1
}

# 1. Disable SMBv1 (if not needed)
Write-Output "Disabling SMBv1..."
try {
    Set-SmbServerConfiguration -EnableSMB1Protocol $false -Force
    Write-Output "SMBv1 has been disabled."
} catch {
    Write-Error "Failed to disable SMBv1: $_"
}

# 2. Enforce SMB signing and reject unencrypted SMB access
Write-Output "Enforcing SMB signing and rejecting unencrypted SMB connections..."
try {
    Set-SmbServerConfiguration -RequireSecuritySignature $true -Force
    Set-SmbServerConfiguration -RejectUnencryptedAccess $true -Force
    Write-Output "SMB signing enforced and unencrypted access rejected."
} catch {
    Write-Error "Failed to update SMB server configuration: $_"
}

# 3. Optionally disable automatic administrative share creation
# Note: Disabling admin shares may impact remote administration and file sharing. 
Write-Output "Disabling automatic creation of administrative shares..."
try {
    $regPath = "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters"
    Set-ItemProperty -Path $regPath -Name "AutoShareServer" -Value 0 -Force
    Set-ItemProperty -Path $regPath -Name "AutoShareWks" -Value 0 -Force
    Write-Output "Automatic administrative share creation has been disabled. A reboot may be required."
} catch {
    Write-Error "Failed to disable administrative shares: $_"
}

# 4. Restrict anonymous (null session) access to SMB and RPC endpoints
Write-Output "Restricting anonymous access via LSA settings..."
try {
    $lsaPath = "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa"
    # 'restrictanonymous' set to 2 prevents anonymous enumeration of SAM accounts and shares.
    Set-ItemProperty -Path $lsaPath -Name "restrictanonymous" -Value 2 -Force
    Write-Output "Anonymous access has been restricted (restrictanonymous=2)."
} catch {
    Write-Error "Failed to restrict anonymous access: $_"
}

Write-Output "SMB hardening measures have been applied. Please verify that these changes do not interfere with legitimate operations and plan for a reboot if necessary."
