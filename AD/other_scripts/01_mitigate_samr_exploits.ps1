# Ensure the script is running with administrative privileges.
if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltinRole]::Administrator)) {
    Write-Error "This script must be run as an Administrator."
    exit 1
}

# Define the LSA registry path
$lsaPath = "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa"

Write-Output "Configuring LSA to restrict anonymous (null session) access..."

try {
    # Set 'restrictanonymous' to 2 which prevents anonymous enumeration of SAM accounts and shares.
    Write-Output "Setting 'restrictanonymous' to 2..."
    Set-ItemProperty -Path $lsaPath -Name "restrictanonymous" -Value 2 -Force

    # Optionally, set 'restrictanonymoussam' to 1 if available.
    # This setting further limits anonymous access to the SAM database.
    if (Get-ItemProperty -Path $lsaPath -Name "restrictanonymoussam" -ErrorAction SilentlyContinue) {
        Write-Output "Setting 'restrictanonymoussam' to 1..."
        Set-ItemProperty -Path $lsaPath -Name "restrictanonymoussam" -Value 1 -Force
    } else {
        Write-Output "'restrictanonymoussam' is not present on this system."
    }

    Write-Output "LSA anonymous access restrictions applied successfully."
    Write-Output "A system restart may be required for all changes to take effect."
}
catch {
    Write-Error "Failed to configure LSA settings: $_"
}